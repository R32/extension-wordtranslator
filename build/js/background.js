// Generated by Haxe 5.0.0-alpha.1
(function ($global) { "use strict";
class Background {
	static loadpage(href,callback) {
		chrome.tabs.query({ url : href},function(list) {
			if(list.length > 0) {
				chrome.tabs.update(list[0].id,{ active : true},callback);
				return;
			}
			chrome.tabs.create({ url : href},callback);
		});
	}
	static main() {
		let lazySendResponse = null;
		let prevMsg = null;
		chrome.runtime.onMessage.addListener(function(query,sender,sendResponse) {
			if(query.respone) {
				if(lazySendResponse != null) {
					lazySendResponse(query.value);
				}
				lazySendResponse = null;
				return false;
			}
			let same = prevMsg == query.value;
			if(same) {
				sendResponse(null);
			} else {
				lazySendResponse = sendResponse;
				prevMsg = query.value;
			}
			chrome.tabs.query({ url : Background.bingurl + "*"},function(list) {
				if(list.length == 0) {
					if(lazySendResponse != null) {
						lazySendResponse(null);
					}
					lazySendResponse = null;
					prevMsg = null;
					Background.loadpage(Background.bingurl);
					return;
				}
				chrome.scripting.executeScript({ target : { tabId : list[0].id}, args : [same ? null : prevMsg], func : function(english) {
					if(english != null) {
						let input = document.getElementById("tta_input_ta");
						input.value = english;
						let output = document.getElementById("tta_output_ta");
						let old = output.value;
						let rolling = null;
						rolling = function() {
							let cur = output.value;
							let len = cur.length;
							if(cur == old || cur.charAt(len - 1) == "." && cur.charAt(len - 2) == ".") {
								window.setTimeout(rolling,100);
								return;
							}
							chrome.runtime.sendMessage({ value : cur, respone : true});
						};
						input.click();
						window.setTimeout(rolling,100);
					}
					document.getElementById("tta_playiconsrc").click();
				}});
			});
			return lazySendResponse != null;
		});
		chrome.webNavigation.onDOMContentLoaded.addListener(function(t) {
			let dot = t.url.indexOf(":");
			if(dot == -1) {
				return;
			}
			switch(t.url.substring(0,dot)) {
			case "file":case "http":case "https":
				break;
			default:
				return;
			}
			chrome.scripting.executeScript({ target : { tabId : t.tabId}, files : ["js/content-script.js"]});
		});
		chrome.action.onClicked.addListener(function(tab) {
			Background.loadpage(chrome.runtime.getURL("options.html"));
		});
	}
}
{
}
Background.bingurl = "https://cn.bing.com/translator";
Background.main();
})(globalThis);
