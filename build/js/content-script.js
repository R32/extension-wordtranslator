// Generated by Haxe 5.0.0-alpha.1+cc105eb
(function ($global) { "use strict";
class ContentScript {
	static main() {
		if(document.body == null || document.documentElement.lang.startsWith("zh") && chrome.i18n.getUILanguage().startsWith("zh")) {
			return;
		}
		let movpos_y;
		let movpos_x = 0;
		movpos_y = 0;
		let range = null;
		let query = [1,""];
		let button = document.getElementById("yangmaowords");
		if(button != null) {
			return;
		}
		let node = document.createElement("div");
		node.id = "yangmaowords";
		node.innerText = "翻译";
		button = node;
		if(button.style == null) {
			return;
		}
		button.style.cssText = "position : absolute;padding : 2px 4px;margin : 0;display : none;border : 1px solid #00bcd4;border-left-width : 12pt;background-color : inherit;font-size : 10pt;cursor : pointer;color : inherit;z-index : 101;";
		let headwidth = devicePixelRatio * 16 | 0;
		let onmove = function(e) {
			e.stopPropagation();
			button.style.left = movpos_x + e.screenX + "px";
			button.style.top = movpos_y + e.screenY + "px";
		};
		let flush = function(s) {
			if(s != null) {
				button.innerText = s;
			}
		};
		button.onclick = function(e) {
			e.stopPropagation();
			if(e.layerX < headwidth) {
				return;
			}
			if(range != null) {
				let sel = document.getSelection();
				if(!sel.isCollapsed && sel.anchorNode.parentNode == button) {
					return;
				}
				sel.removeAllRanges();
				sel.addRange(range);
			}
			chrome.runtime.sendMessage(query,flush);
		};
		button.oncontextmenu = function(e) {
			let sel = document.getSelection();
			if(!sel.isCollapsed && sel.anchorNode.parentNode == button) {
				return;
			}
			ContentScript.halt(e);
			button.style.display = "none";
		};
		let moving = false;
		button.onmousedown = function(e) {
			if(e.layerX >= headwidth) {
				return;
			}
			ContentScript.halt(e);
			movpos_x = button.offsetLeft - e.screenX;
			movpos_y = button.offsetTop - e.screenY;
			document.removeEventListener("mousemove",onmove,true);
			document.addEventListener("mousemove",onmove,true);
			button.style.cursor = "move";
			moving = true;
		};
		document.onmouseup = function(e) {
			if(moving) {
				moving = false;
				document.removeEventListener("mousemove",onmove,true);
				button.style.cursor = "pointer";
				return;
			}
			let sel = document.getSelection();
			if(sel.isCollapsed || sel.anchorNode.parentNode == button) {
				return;
			}
			let value = sel.toString().trimStart();
			if(value == "" || query[1] == value) {
				return;
			}
			button.style.display = "inline-block";
			range = sel.getRangeAt(0);
			let rect = range.getClientRects()[0];
			button.style.left = rect.left + window.pageXOffset + "px";
			button.style.top = Math.max(rect.top + window.pageYOffset - button.offsetHeight - 2,0) + "px";
			query[1] = value;
		};
		document.body.appendChild(button);
	}
	static halt(e) {
		e.preventDefault();
		e.stopPropagation();
	}
}
{
}
ContentScript.main();
})(window);
