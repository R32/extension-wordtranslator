// Generated by Haxe 5.0.0-alpha.1+bdae3e7
(function ($global) { "use strict";
function halt(e) {
	e.preventDefault();
	e.stopPropagation();
}
function main() {
	if(document.body == null || document.body.tagName != "BODY" || document.documentElement.lang.startsWith("zh") && chrome.i18n.getUILanguage().startsWith("zh")) {
		return;
	}
	let pos_y;
	let pos_x = 0;
	pos_y = 0;
	let msg = [1,""];
	let range = null;
	let view = document.getElementById("yangmaowords");
	if(view) {
		return;
	}
	let node = document.createElement("div");
	node.id = "yangmaowords";
	node.innerText = "翻译";
	view = node;
	if(view.style == null) {
		return;
	}
	view.style.cssText = "position : absolute;padding : 2px 4px;margin : 0;display : none;border : 1px solid #00bcd4;border-left-width : 12pt;background-color : inherit;font-size : 10pt;cursor : pointer;color : inherit;z-index : 101;";
	let headwidth = devicePixelRatio * 16 | 0;
	let onmove = function(e) {
		e.stopPropagation();
		view.style.left = pos_x + e.screenX + "px";
		view.style.top = pos_y + e.screenY + "px";
	};
	let flush = function(s) {
		if(s) {
			view.innerText = s;
		}
	};
	view.onclick = function(e) {
		e.stopPropagation();
		if(e.layerX < headwidth) {
			return;
		}
		if(range) {
			let sel = document.getSelection();
			if(!sel.isCollapsed && sel.anchorNode.parentNode == view) {
				return;
			}
			sel.removeAllRanges();
			sel.addRange(range);
		}
		chrome.runtime.sendMessage(msg,flush);
	};
	view.oncontextmenu = function(e) {
		let sel = document.getSelection();
		if(!sel.isCollapsed && sel.anchorNode.parentNode == view) {
			return;
		}
		halt(e);
		view.style.display = "none";
	};
	let moving = false;
	view.onmousedown = function(e) {
		if(e.layerX >= headwidth) {
			return;
		}
		halt(e);
		pos_x = view.offsetLeft - e.screenX;
		pos_y = view.offsetTop - e.screenY;
		document.removeEventListener("mousemove",onmove,true);
		document.addEventListener("mousemove",onmove,true);
		view.style.cursor = "move";
		moving = true;
	};
	document.onmouseup = function(e) {
		if(moving) {
			moving = false;
			document.removeEventListener("mousemove",onmove,true);
			view.style.cursor = "pointer";
			return;
		}
		let sel = document.getSelection();
		if(sel.isCollapsed || sel.anchorNode.parentNode == view) {
			return;
		}
		let value = sel.toString().trimStart();
		if(value == "" || msg[1] == value) {
			return;
		}
		view.style.display = "inline-block";
		range = sel.getRangeAt(0);
		let rect = range.getClientRects()[0];
		view.style.left = rect.left + window.pageXOffset + "px";
		view.style.top = Math.max(rect.top + window.pageYOffset - view.offsetHeight - 2,0) + "px";
		msg[1] = value;
	};
	document.body.appendChild(view);
}
{
}
main();
})(window);
